(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))g(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&g(l)}).observe(document,{childList:!0,subtree:!0});function y(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function g(n){if(n.ep)return;n.ep=!0;const o=y(n);fetch(n.href,o)}})();const A=p=>typeof p!="string"?p:p.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]);document.addEventListener("DOMContentLoaded",()=>{const p=document.querySelector(".list-area"),e=document.forms["comments-load"];e.videoId=e.elements["video-id"],e.submitButton=e.elements["submit-button"];const y=document.querySelector("details"),g=document.querySelector(".config"),n=document.querySelector(".watch-link a"),o=document.getElementById("comments-list"),l=document.querySelector(".detail-pc"),$=document.title,b="/nv-comment-viewer",w=location.pathname.replace(b,"").slice(1),P=`${location.origin}${b}/`,T=()=>window.innerWidth<1024;let h=null,v=null,E=[];const M=()=>e.submitButton.disabled=!e.checkValidity();e.addEventListener("input",M);const x=i=>{const t={text:A(i.body).replace(/\n/g,"<br>"),nicoru:i.nicoruCount!==0?i.nicoruCount:"",time:(d=>d.getUTCDate()-1?(d.setUTCMonth(d.getUTCDate()-2),d.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):d.getUTCHours()?d.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2}):d.toLocaleString([],{timeZone:"UTC",minute:"numeric",second:"numeric",fractionalSecondDigits:2}))(new Date(Number(i.vposMsec)))};return`<li data-id="${i.id}" data-user-id="${i.userId}">
      <span class="text">${t.text}</span><span class="nicoru">${t.nicoru}</span><span class="time">${t.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(i)}<\/script>
    </li>
    `},O=i=>{let t="";E=[],i.forEach(m=>{t+=x(m),E.push(m.vposMsec)}),o.insertAdjacentHTML("beforeend",t)};if(e.addEventListener("submit",async i=>{i.preventDefault(),e.submitButton.disabled=!0,e.submitButton.textContent="読み込み中...",o.textContent="";let t=e.videoId.value;const m=t.lastIndexOf("/")+1,d=t.includes("?")?t.indexOf("?"):void 0,f=t.slice(m,d);if(e.videoId.value=f,n.href=`https://www.nicovideo.jp/watch_tmp/${f}`,!h||h.client.watchId!==f){const c=new URL("watch",P);c.searchParams.append("id",f),await fetch(c).then(async r=>{r.status!==200&&console.log("error or no content",r.status);const s=await r.json();s.meta.status!==200?(console.error("Error:",s.meta.status),console.dir(s.meta),alert(`エラー:${s.meta.errorCode}`)):h=s.data}).catch(r=>{console.error("Failed to load",r)})}if((h==null?void 0:h.client.watchId)===f){const c=new URL("comments",P);c.searchParams.append("id",f),await fetch(c).then(async r=>{r.status!==200&&console.log("error or no content",r.status);const s=await r.json();s.meta.status!==200?(console.error("Error:",s.meta.status),console.dir(s.meta),alert("エラー:"+s.meta.status)):v=s.data}).catch(r=>{console.error("Failed to load",r)}),v.comments.length?(g.hidden=!1,v.comments.sort((r,s)=>r.vposMsec-s.vposMsec),O(v.comments),document.title=`${h.video.title} - ${$}`,history.pushState(null,"",`${b}/${f}`)):(console.log("not comments found"),alert("コメントがありませんでした。"))}e.submitButton.disabled=!1,e.submitButton.textContent="取得"},{passive:!1}),/(^sm|^nm|^so)[0-9]+/.test(w)){y.open=!1;const i=w;e.videoId.value=i,e.requestSubmit()}o.addEventListener("click",i=>{const t=i.target.closest("li"),m=document.querySelector(".detail-sp"),d=document.getElementsByClassName("same-user");if(!t||t.classList.contains("detail-sp"))return;if([...d].forEach(a=>a.classList.remove("same-user")),t.nextElementSibling&&t.nextElementSibling.classList.contains("detail-sp")){l.textContent="",m.remove();return}l.textContent!==""&&(l.textContent=""),m&&m.remove();const f=T()?t.offsetTop-2-g.offsetHeight-10:t.offsetTop-(p.clientHeight-t.offsetHeight)/2;p.scrollTo({top:f});const c=JSON.parse(t.querySelector(".raw-data").textContent),C=document.createElement("dl"),r={id:"コメントID",no:"コメント番号",vposMsec:"再生時間",message:"コメント",command:"コマンド",userId:"ユーザーID",isPremium:"プレミアム会員",score:"NGスコア",postedAt:"日時",nicoruCount:"ニコられた数",source:"ソース",isMyPost:"自分の投稿"};let s="";Object.keys(c).forEach(a=>{let u=c[a];switch(a){case"vposMsec":const S=new Date(Number(u));S.getUTCDate()-1?(S.setUTCMonth(S.getUTCDate()-2),u=S.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):u=S.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"postedAt":u=new Date(u).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"userId":!c.commands.includes("184")&&(u=`<a href="https://nico.ms/user/${c.userId}" target="_blank">${u}</a>`);break;case"isPremium":case"isMyPost":u=u?"はい":"いいえ";break}s+=`<dt>${r[a]||a}</dt>
      <dd>${u}</dd>
      `}),C.innerHTML=s;const I=[...o.children].filter(a=>a.dataset.userId===c.userId),U=`<dl>
      <dt>コメント回数</dt>
      <dd>${I.findIndex(a=>a.dataset.id===c.id)+1}回目/全${I.length}回中</dd>
    </dl>
    `;l.appendChild(C.cloneNode(!0)),l.appendChild(document.createElement("hr")),l.insertAdjacentHTML("beforeend",U);const L=document.createElement("li");L.classList.add("detail-sp"),L.appendChild(C),L.appendChild(document.createElement("hr")),L.insertAdjacentHTML("beforeend",U),t.insertAdjacentElement("afterend",L),I.forEach(a=>a.classList.add("same-user"))})});
