(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))I(o);new MutationObserver(o=>{for(const m of o)if(m.type==="childList")for(const w of m.addedNodes)w.tagName==="LINK"&&w.rel==="modulepreload"&&I(w)}).observe(document,{childList:!0,subtree:!0});function b(o){const m={};return o.integrity&&(m.integrity=o.integrity),o.referrerPolicy&&(m.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?m.credentials="include":o.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function I(o){if(o.ep)return;o.ep=!0;const m=b(o);fetch(o.href,m)}})();const R=s=>typeof s!="string"?s:s.replace(/[&'`"<>]/g,n=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[n]),_={string(s){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array(s).fill(null).map(()=>n[Math.floor(Math.random()*n.length)]).join("")},number(s,n){return Math.floor(Math.random()*(n-s)+s)}};document.addEventListener("DOMContentLoaded",()=>{var O;const s=document.querySelector(".list-area"),n=document.forms["comments-load"];n.videoId=n.elements["video-id"],n.submitButton=n.elements["submit-button"];const b=document.querySelector("details"),I=document.querySelector(".config"),o=document.getElementById("thread"),m=document.querySelector(".watch-link a"),w=document.querySelector(".nico-ad"),q=document.getElementById("nico-ad"),y=document.getElementById("comments-list"),S=document.getElementById("comments-sync"),C=document.querySelector(".detail-pc"),B=document.title,U=location.pathname,x=`${location.origin}${U}/`,A=location.search.slice(1),F=()=>window.innerWidth<1024;let f=null,v=null,T=!1,P=[],M=!0,$=0;const H=()=>n.submitButton.disabled=!n.checkValidity();n.addEventListener("input",H);const K=e=>{const t={text:R(e.body).replace(/\n/g,"<br>"),nicoru:e.nicoruCount!==0?e.nicoruCount:"",time:(a=>a.getUTCDate()-1?(a.setUTCMonth(a.getUTCDate()-2),a.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):a.getUTCHours()?a.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2}):a.toLocaleString([],{timeZone:"UTC",minute:"numeric",second:"numeric",fractionalSecondDigits:2}))(new Date(Number(e.vposMs)))};return`<li data-id="${e.id}" data-user-id="${e.userId}">
      <span class="text">${t.text}</span><span class="nicoru">${t.nicoru}</span><span class="time">${t.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(e)}<\/script>
    </li>
    `},N=e=>{let t="";P=[],e.forEach(i=>{t+=K(i),P.push(i.vposMs)}),y.insertAdjacentHTML("beforeend",t)};let k=null;if(n.addEventListener("submit",async e=>{e.preventDefault(),n.submitButton.disabled=!0,n.submitButton.textContent="読み込み中...",y.textContent="";let t=n.videoId.value;const i=t.lastIndexOf("/")+1,a=t.includes("?")?t.indexOf("?"):void 0,l=t.slice(i,a);if(n.videoId.value=l,m.href=`https://nico.ms/${l}`,!f||f.client.watchId!==l){T&&f.client.watchId!==l&&(T=!1,w.hidden=!0);const d=new URL("watch_v3_guest",x),u=d.searchParams;u.append("id",l);const h=`${_.string(10)}_${Math.floor(Date.now()/1e3)}`;u.append("actionTrackId",h),await fetch(d,{method:"POST"}).then(async c=>{c.status!==200&&console.log("error or no content",c.status);const r=await c.json();r.meta.errorCode==="FORBIDDEN"?(console.error("Error:",r.meta.errorCode,r.data.reasonCode),alert(`エラー:${r.meta.errorCode}、理由:${r.data.reasonCode}`)):r.meta.errorCode?(console.error("Error:",r.meta.errorCode),alert("エラー:"+r.meta.errorCode)):(f=r.data,k=null)}).catch(c=>{console.error("Failed to load",c)})}if((f==null?void 0:f.client.watchId)===l){const d=f.comment.nvComment;await fetch(`${d.server}/v1/threads`,{method:"POST",headers:{"Content-Type":"application/json","X-Frontend-Id":"1","X-Frontend-Version":"0"},body:JSON.stringify({params:d.params,threadKey:k||d.threadKey,additionals:{}})}).then(async u=>{if(u.status!==200&&console.log("error or no content",u.status),v=await u.json(),v.meta.errorCode==="EXPIRED_TOKEN"){const h=new URL("v1_comment_keys_thread",x);h.searchParams.append("videoId",l),await fetch(h,{}).then(async r=>(r.status!==200&&console.log("error or no content",r.status),r.json())).then(r=>{k=r.data.threadKey,n.requestSubmit()}).catch(r=>{console.error("Failed to load",r)})}else if(v.meta.errorCode)console.error("Error:",v.meta.errorCode),alert("エラー:"+v.meta.errorCode);else if(!v.data.globalComments[0].count)console.log("not comments found"),alert("コメントがありませんでした。");else{o.value="default",I.hidden=!1;const h=v.data.threads.find(c=>c.fork==="main");h.comments.sort((c,r)=>c.vposMs-r.vposMs),N(h.comments),document.title=`${f.video.title} - ${B}`,history.pushState(null,"",`${U}?${l}`)}}).catch(u=>{console.error("Failed to load",u)})}n.submitButton.disabled=!1,n.submitButton.textContent="取得"},{passive:!1}),o.addEventListener("change",()=>{y.textContent="";const e=v.data.threads.find(t=>{switch(o.value){case"default":return t.fork==="main";default:return t.fork===o.value}});e.comments.sort((t,i)=>t.vposMs-i.vposMs),N(e.comments)}),/(^sm|^nm|^so)[0-9]+/.test(A)){b.open=!1;const e=A;n.videoId.value=e,n.requestSubmit()}window.addEventListener("message",e=>{if(e.origin==="https://www.nicovideo.jp")switch(e.data.eventName){case"sendData":T=!0,b.open=!1,w.hidden=!1,f=e.data.data;const t=f.client.watchId;n.videoId.value=t,n.requestSubmit(),s.addEventListener("scroll",i=>{T?Math.abs($-s.scrollTop)>=3?(M=!1,S.hidden=!1):(M=!0,S.hidden=!0):S.hidden=!0});break;case"playerMetadataChange":if(M){const i=f.video.duration,a=e.data.data.progressPercentage,l=q.checked,d=Math.floor((i+(l?10:0))*1e3*a),u=P.findIndex(c=>c>d),h=y.children[u];$=h.offsetTop-s.clientHeight+h.offsetHeight+2,s.scrollTo({top:$,behavior:"instant"})}break;default:console.log(e.data);break}}),(O=window.opener)==null||O.postMessage({eventName:"ready"},"https://www.nicovideo.jp"),document.addEventListener("visibilitychange",()=>{var e,t;switch(document.visibilityState){case"hidden":(e=window.opener)==null||e.postMessage({eventName:"bye"},"https://www.nicovideo.jp");break;case"visible":(t=window.opener)==null||t.postMessage({eventName:"returned"},"https://www.nicovideo.jp");break}}),y.addEventListener("click",e=>{const t=e.target.closest("li"),i=document.querySelector(".detail-sp"),a=document.getElementsByClassName("same-user");if(!t||t.classList.contains("detail-sp"))return;if([...a].forEach(p=>p.classList.remove("same-user")),t.nextElementSibling&&t.nextElementSibling.classList.contains("detail-sp")){C.textContent="",i.remove();return}C.textContent!==""&&(C.textContent=""),i&&i.remove();const l=F()?t.offsetTop-2-I.offsetHeight-10:t.offsetTop-(s.clientHeight-t.offsetHeight)/2;s.scrollTo({top:l});const d=JSON.parse(t.querySelector(".raw-data").textContent),u=document.createElement("dl"),h={id:"コメントID",no:"コメント番号",vposMs:"再生時間",body:"コメント",commands:"コマンド",userId:"ユーザーID",isPremium:"プレミアム会員",score:"NGスコア",postedAt:"日時",nicoruCount:"ニコられた数",source:"ソース",isMyPost:"自分の投稿"};let c="";Object.keys(d).forEach(p=>{let g=d[p];switch(p){case"vposMs":const E=new Date(Number(g));E.getUTCDate()-1?(E.setUTCMonth(E.getUTCDate()-2),g=E.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):g=E.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"commands":g=g.join(" ");break;case"postedAt":g=new Date(g).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"userId":!d.commands.includes("184")&&(g=`<a href="https://nico.ms/user/${d.userId}" target="_blank">${g}</a>`);break;case"isPremium":case"isMyPost":g=g?"はい":"いいえ";break}c+=`<dt>${h[p]||p}</dt>
      <dd>${g}</dd>
      `}),u.innerHTML=c;const D=[...y.children].filter(p=>p.dataset.userId===d.userId),j=`<dl>
      <dt>コメント回数</dt>
      <dd>${D.findIndex(p=>p.dataset.id===d.id)+1}回目/全${D.length}回中</dd>
    </dl>
    `;C.appendChild(u.cloneNode(!0)),C.appendChild(document.createElement("hr")),C.insertAdjacentHTML("beforeend",j);const L=document.createElement("li");L.classList.add("detail-sp"),L.appendChild(u),L.appendChild(document.createElement("hr")),L.insertAdjacentHTML("beforeend",j),t.insertAdjacentElement("afterend",L),D.forEach(p=>p.classList.add("same-user"))}),S.addEventListener("click",()=>{var e;M=!0,S.hidden=!0,(e=document.querySelector(".detail-sp"))==null||e.previousElementSibling.click()}),window.opener&&document.addEventListener("keydown",e=>{var a;["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"," "].some(l=>l===e.key)&&(e.preventDefault(),(a=window.opener)==null||a.postMessage({eventName:"keyDown",data:e.key},"https://www.nicovideo.jp"))})});
