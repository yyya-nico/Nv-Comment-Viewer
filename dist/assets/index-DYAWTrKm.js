(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))I(a);new MutationObserver(a=>{for(const m of a)if(m.type==="childList")for(const l of m.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&I(l)}).observe(document,{childList:!0,subtree:!0});function C(a){const m={};return a.integrity&&(m.integrity=a.integrity),a.referrerPolicy&&(m.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?m.credentials="include":a.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function I(a){if(a.ep)return;a.ep=!0;const m=C(a);fetch(a.href,m)}})();const R=h=>typeof h!="string"?h:h.replace(/[&'`"<>]/g,n=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[n]),K={string(h){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array(h).fill(null).map(()=>n[Math.floor(Math.random()*n.length)]).join("")},number(h,n){return Math.floor(Math.random()*(n-h)+h)}};document.addEventListener("DOMContentLoaded",()=>{var O;const h=document.querySelector("header"),n=document.forms["comments-load"];n.videoId=n.elements["video-id"],n.submitButton=n.elements["submit-button"];const C=document.querySelector("details"),I=document.querySelector(".config"),a=document.getElementById("thread"),m=document.querySelector(".watch-link a"),l=document.getElementById("comments-list"),y=document.getElementById("comments-sync"),b=document.querySelector(".detail-pc"),q=document.title,P="/nv-comment-viewer",A=location.pathname.replace(P,"").slice(1),M=`${location.origin}${P}/`,B=()=>window.innerWidth<1024;let u=null,v=null,S=!1,k=!1,x=[],E=!0,D=0;const H=()=>n.submitButton.disabled=!n.checkValidity();n.addEventListener("input",H);const F=e=>{const t={text:R(e.body).replace(/\n/g,"<br>"),nicoru:e.nicoruCount!==0?e.nicoruCount:"",time:(i=>i.getUTCDate()-1?(i.setUTCMonth(i.getUTCDate()-2),i.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):i.getUTCHours()?i.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2}):i.toLocaleString([],{timeZone:"UTC",minute:"numeric",second:"numeric",fractionalSecondDigits:2}))(new Date(Number(e.vposMs)))};return`<li data-id="${e.id}" data-user-id="${e.userId}" tabindex="0">
      <span class="text">${t.text}</span><span class="nicoru">${t.nicoru}</span><span class="time">${t.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(e)}<\/script>
    </li>
    `},N=e=>{let t="";x=[],e.forEach(s=>{t+=F(s),x.push(s.vposMs)}),l.insertAdjacentHTML("beforeend",t)};let U=null;if(n.addEventListener("submit",async e=>{e.preventDefault(),n.submitButton.disabled=!0,n.submitButton.textContent="読み込み中...",l.textContent="";let t=n.videoId.value;const s=t.lastIndexOf("/")+1,i=t.includes("?")?t.indexOf("?"):void 0,c=t.slice(s,i);if(n.videoId.value=c,m.href=`https://nico.ms/${c}`,(u==null?void 0:u.client.watchId)!==c){S&&e.isTrusted&&(S=!1);const f=new URL("watch_v3_guest",M),d=f.searchParams;d.append("id",c);const r=`${K.string(10)}_${Math.floor(Date.now()/1e3)}`;d.append("actionTrackId",r),await fetch(f,{method:"POST"}).then(async p=>{p.status!==200&&console.log("error or no content",p.status);const o=await p.json();o.meta.errorCode==="FORBIDDEN"?(console.error("Error:",o.meta.errorCode,o.data.reasonCode),alert(`エラー:${o.meta.errorCode}、理由:${o.data.reasonCode}`)):o.meta.errorCode?(console.error("Error:",o.meta.errorCode),alert("エラー:"+o.meta.errorCode)):(u=o.data,U=null)}).catch(p=>{console.error("Failed to load",p)})}if((u==null?void 0:u.client.watchId)===c){const f=u.comment.nvComment;await fetch(`${f.server}/v1/threads`,{method:"POST",headers:{"X-Client-Os-Type":"others","X-Frontend-Id":"6","X-Frontend-Version":"0"},body:JSON.stringify({params:f.params,threadKey:U||f.threadKey,additionals:{}})}).then(async d=>{if(d.status!==200&&console.log("error or no content",d.status),v=await d.json(),v.meta.errorCode==="EXPIRED_TOKEN"){const r=new URL("v1_comment_keys_thread",M);r.searchParams.append("videoId",c),await fetch(r,{}).then(async o=>(o.status!==200&&console.log("error or no content",o.status),o.json())).then(o=>{U=o.data.threadKey,n.requestSubmit()}).catch(o=>{console.error("Failed to load",o)})}else if(v.meta.errorCode)console.error("Error:",v.meta.errorCode),alert("エラー:"+v.meta.errorCode);else if(!v.data.globalComments[0].count)console.log("not comments found"),alert("コメントがありませんでした。");else{a.value="default",I.hidden=!1;const r=v.data.threads.find(p=>p.fork==="main");r.comments.sort((p,o)=>p.vposMs-o.vposMs),N(r.comments),document.title=`${u.video.title} - ${q}`,history.pushState(null,"",`${P}/${c}`)}}).catch(d=>{console.error("Failed to load",d)})}S&&(k=(async()=>{const f=new URL("pickup_supporters",M);f.searchParams.append("id",c),await fetch(f,{}).then(async r=>(r.status!==200&&console.log("error or no content",r.status),r.json())).then(r=>r.meta.status===200).catch(r=>{console.error("Failed to load",r)})})(),console.log("isIncludeNicoAd:",k)),n.submitButton.disabled=!1,n.submitButton.textContent="取得"},{passive:!1}),a.addEventListener("change",()=>{l.textContent="";const e=v.data.threads.find(t=>{switch(a.value){case"default":return t.fork==="main";default:return t.fork===a.value}});e.comments.sort((t,s)=>t.vposMs-s.vposMs),N(e.comments)}),/(^sm|^nm|^so)[0-9]+/.test(A)){C.open=!1;const e=A;n.videoId.value=e,n.requestSubmit()}if(window.addEventListener("message",e=>{if(e.origin==="https://www.nicovideo.jp")switch(e.data.eventName){case"sendData":case"sendVideoId":S=!0,C.open=!1;let t="";e.data.eventName==="sendData"?(u=e.data.data,t=u.client.watchId):(u=null,t=e.data.data.videoId),n.videoId.value=t,n.requestSubmit(),window.addEventListener("scroll",s=>{S?Math.abs(D-window.scrollY)>=3?(E=!1,y.hidden=!1):(E=!0,y.hidden=!0):y.hidden=!0});break;case"playerMetadataChange":if(E&&!n.submitButton.disabled){const s=u.video.duration,i=e.data.data.progressPercentage,c=Math.floor((s+(k?10:0))*1e3*i),f=x.findIndex(r=>r>c),d=l.children[f];D=d.offsetTop-window.innerHeight+d.offsetHeight+2,window.scrollTo({top:D,behavior:"instant"})}break;default:console.log(e.data);break}}),(O=window.opener)==null||O.postMessage({eventName:"ready"},"https://www.nicovideo.jp"),document.addEventListener("visibilitychange",()=>{var e,t;switch(document.visibilityState){case"hidden":(e=window.opener)==null||e.postMessage({eventName:"bye"},"https://www.nicovideo.jp");break;case"visible":(t=window.opener)==null||t.postMessage({eventName:"returned"},"https://www.nicovideo.jp");break}}),l.addEventListener("click",e=>{const t=e.target.closest("li"),s=document.querySelector(".detail-sp"),i=document.getElementsByClassName("same-user");if(!t||t.classList.contains("detail-sp"))return;if([...i].forEach(w=>w.classList.remove("same-user")),t.nextElementSibling&&t.nextElementSibling.classList.contains("detail-sp")){b.textContent="",s.remove();return}b.textContent!==""&&(b.textContent=""),s&&s.remove(),E=!1,y.hidden=!1;const c=B()?t.offsetTop-(h.offsetHeight+10+I.offsetHeight+2+10):t.offsetTop-(window.innerHeight-h.offsetHeight-t.offsetHeight)/2,f=e.isTrusted?"smooth":"instant";window.scrollTo({top:c,behavior:f});const d=JSON.parse(t.querySelector(".raw-data").textContent),r=document.createElement("dl"),p={id:"コメントID",no:"コメント番号",vposMs:"再生時間",body:"コメント",commands:"コマンド",userId:"ユーザーID",isPremium:"プレミアム会員",score:"NGスコア",postedAt:"日時",nicoruCount:"ニコられた数",source:"ソース",isMyPost:"自分の投稿"};let o="";Object.entries(d).forEach(([w,g])=>{switch(w){case"vposMs":const T=new Date(Number(g));T.getUTCDate()-1?(T.setUTCMonth(T.getUTCDate()-2),g=T.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):g=T.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"commands":g=g.join(" ");break;case"postedAt":g=new Date(g).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"userId":!d.commands.includes("184")&&(g=`<a href="https://nico.ms/user/${d.userId}" target="_blank">${g}</a>`);break;case"isPremium":case"isMyPost":g=g?"はい":"いいえ";break}o+=`<dt>${p[w]||w}</dt>
      <dd>${g}</dd>
      `}),r.innerHTML=o;const $=[...l.children].filter(w=>w.dataset.userId===d.userId),j=`<dl>
      <dt>コメント回数</dt>
      <dd>${$.findIndex(w=>w.dataset.id===d.id)+1}回目/全${$.length}回中</dd>
    </dl>
    `;b.appendChild(r.cloneNode(!0)),b.appendChild(document.createElement("hr")),b.insertAdjacentHTML("beforeend",j);const L=document.createElement("li");L.classList.add("detail-sp"),L.appendChild(r),L.appendChild(document.createElement("hr")),L.insertAdjacentHTML("beforeend",j),t.insertAdjacentElement("afterend",L),$.forEach(w=>w.classList.add("same-user"))}),y.addEventListener("click",()=>{var e;E=!0,y.hidden=!0,(e=document.querySelector(".detail-sp"))==null||e.previousElementSibling.click()}),window.opener)document.addEventListener("keydown",e=>{var i;["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"," "].some(c=>c===e.key)&&(e.preventDefault(),(i=window.opener)==null||i.postMessage({eventName:"keyDown",data:e.key},"https://www.nicovideo.jp"))});else{let e=null;l.addEventListener("focus",t=>{e=t.target},!0),l.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":t.preventDefault(),(()=>{const s=e?e.previousElementSibling??l.lastElementChild:l.firstElementChild;s.click(),s.focus()})();break;case"ArrowDown":t.preventDefault(),(()=>{var i,c;const s=((i=e==null?void 0:e.nextElementSibling)!=null&&i.classList.contains("detail-sp")?(c=e.nextElementSibling)==null?void 0:c.nextElementSibling:e==null?void 0:e.nextElementSibling)??l.firstElementChild;s.click(),s.focus()})();break;case" ":case"Enter":t.target===document.activeElement&&(t.preventDefault(),t.target.click(),t.target.focus());break}})}});
