(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))S(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&S(l)}).observe(document,{childList:!0,subtree:!0});function L(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function S(s){if(s.ep)return;s.ep=!0;const o=L(s);fetch(s.href,o)}})();const q=v=>typeof v!="string"?v:v.replace(/[&'`"<>]/g,n=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[n]);document.addEventListener("DOMContentLoaded",()=>{const v=document.querySelector("header"),n=document.forms["comments-load"];n.videoId=n.elements["video-id"],n.submitButton=n.elements["submit-button"];const L=document.querySelector("details"),S=document.querySelector(".config"),s=document.querySelector(".watch-link a"),o=document.getElementById("comments-list"),l=document.querySelector(".detail-pc"),M=document.title,y="/nv-comment-viewer",E=location.pathname.replace(y,"").slice(1),I=`${location.origin}${y}/`,D=()=>window.innerWidth<1024;let p=null,C=null,P=[];const $=()=>n.submitButton.disabled=!n.checkValidity();n.addEventListener("input",$);const A=t=>{const e={text:q(t.message).replace(/\n/g,"<br>"),time:(c=>c.getUTCDate()-1?(c.setUTCMonth(c.getUTCDate()-2),c.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):c.getUTCHours()?c.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2}):c.toLocaleString([],{timeZone:"UTC",minute:"numeric",second:"numeric",fractionalSecondDigits:2}))(new Date(Number(t.vposMsec)))};return`<li data-id="${t.id}" tabindex="0">
      <span class="text">${e.text}</span><span class="time">${e.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(t)}<\/script>
    </li>
    `},k=t=>{let e="";P=[],t.forEach(a=>{e+=A(a),P.push(a.vposMsec)}),o.insertAdjacentHTML("beforeend",e)};if(n.addEventListener("submit",async t=>{t.preventDefault(),n.submitButton.disabled=!0,n.submitButton.textContent="読み込み中...",o.textContent="";let e=n.videoId.value;const a=e.lastIndexOf("/")+1,c=e.includes("?")?e.indexOf("?"):void 0,u=e.slice(a,c);if(n.videoId.value=u,s.href=`https://www.nicovideo.jp/watch_tmp/${u}`,!p||p.client.watchId!==u){const h=new URL("watch",I);h.searchParams.append("id",u),await fetch(h).then(async i=>{i.status!==200&&console.log("error or no content",i.status);const r=await i.json();r.meta.status!==200?(console.error("Error:",r.meta.status),console.dir(r.meta),alert(`エラー:${r.meta.errorCode}`)):p=r.data}).catch(i=>{console.error("Failed to load",i)})}if((p==null?void 0:p.client.watchId)===u){const h=new URL("comments",I);h.searchParams.append("id",u),await fetch(h).then(async i=>{i.status!==200&&console.log("error or no content",i.status);const r=await i.json();r.meta.status!==200?(console.error("Error:",r.meta.status),console.dir(r.meta),alert("エラー:"+r.meta.errorCode)):C=r.data}).catch(i=>{console.error("Failed to load",i)}),C.comments.length?(S.hidden=!1,C.comments.sort((i,r)=>i.vposMsec-r.vposMsec),k(C.comments),document.title=`${p.video.title} - ${M}`,history.pushState(null,"",`${y}/${u}`)):(console.log("not comments found"),alert("コメントがありませんでした。"))}n.submitButton.disabled=!1,n.submitButton.textContent="取得"},{passive:!1}),/(^sm|^nm|^so)[0-9]+/.test(E)){L.open=!1;const t=E;n.videoId.value=t,n.requestSubmit()}o.addEventListener("click",t=>{const e=t.target.closest("li"),a=document.querySelector(".detail-sp"),c=document.getElementsByClassName("same-user");if(!e||e.classList.contains("detail-sp"))return;if([...c].forEach(f=>f.classList.remove("same-user")),e.nextElementSibling&&e.nextElementSibling.classList.contains("detail-sp")){l.textContent="",a.remove();return}l.textContent!==""&&(l.textContent=""),a&&a.remove();const u=D()?e.offsetTop-2-10:e.offsetTop-(window.innerHeight-v.offsetHeight-e.offsetHeight)/2,h=t.isTrusted?"smooth":"instant";window.scrollTo({top:u,behavior:h});const g=JSON.parse(e.querySelector(".raw-data").textContent),i=document.createElement("dl"),r={id:"コメントID",no:"コメント番号",vposMsec:"再生時間",message:"コメント",command:"コマンド",userId:"ユーザーID",isPremium:"プレミアム会員",score:"NGスコア",postedAt:"日時",nicoruCount:"ニコられた数",source:"ソース",isMyPost:"自分の投稿"};let x="";Object.keys(g).forEach(f=>{let d=g[f];switch(f){case"vposMsec":const w=new Date(Number(d));w.getUTCDate()-1?(w.setUTCMonth(w.getUTCDate()-2),d=w.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):d=w.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"postedAt":d=new Date(d).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"command":d||(d="(なし)");break;case"userId":!g.command.includes("184")&&(d=`<a href="https://nico.ms/user/${g.userId}" target="_blank">${d}</a>`);break;case"isPremium":case"isMyPost":d=d?"はい":"いいえ";break}x+=`<dt>${r[f]||f}</dt>
      <dd>${d}</dd>
      `}),i.innerHTML=x;const T=o.children,O=[...T].find(f=>f.dataset.id===g.id),U=`<dl>
      <dt>コメント数</dt>
      <dd>${T.length}コメ</dd>
    </dl>
    `;l.appendChild(i.cloneNode(!0)),l.appendChild(document.createElement("hr")),l.insertAdjacentHTML("beforeend",U);const b=document.createElement("li");b.classList.add("detail-sp"),b.appendChild(i),b.appendChild(document.createElement("hr")),b.insertAdjacentHTML("beforeend",U),e.insertAdjacentElement("afterend",b),O.classList.add("same-user")});let m=null;o.addEventListener("focus",t=>{m=t.target},!0),o.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":t.preventDefault(),(()=>{const e=m?m.previousElementSibling??o.lastElementChild:o.firstElementChild;e.click(),e.focus()})();break;case"ArrowDown":t.preventDefault(),(()=>{var a,c;const e=((a=m==null?void 0:m.nextElementSibling)!=null&&a.classList.contains("detail-sp")?(c=m.nextElementSibling)==null?void 0:c.nextElementSibling:m==null?void 0:m.nextElementSibling)??o.firstElementChild;e.click(),e.focus()})();break;case" ":case"Enter":t.target===document.activeElement&&(t.preventDefault(),t.target.click(),t.target.focus());break}})});
