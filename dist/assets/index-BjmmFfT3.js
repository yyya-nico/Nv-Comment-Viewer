(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))I(a);new MutationObserver(a=>{for(const m of a)if(m.type==="childList")for(const c of m.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&I(c)}).observe(document,{childList:!0,subtree:!0});function C(a){const m={};return a.integrity&&(m.integrity=a.integrity),a.referrerPolicy&&(m.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?m.credentials="include":a.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function I(a){if(a.ep)return;a.ep=!0;const m=C(a);fetch(a.href,m)}})();const R=l=>typeof l!="string"?l:l.replace(/[&'`"<>]/g,n=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[n]),K=l=>l.replace(/\n/g,"<br>"),_={string(l){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array(l).fill(null).map(()=>n[Math.floor(Math.random()*n.length)]).join("")},number(l,n){return Math.floor(Math.random()*(n-l)+l)}};document.addEventListener("DOMContentLoaded",()=>{var O;const l=document.querySelector("header"),n=document.forms["comments-load"];n.videoId=n.elements["video-id"],n.submitButton=n.elements["submit-button"];const C=document.querySelector("details"),I=document.querySelector(".config"),a=document.getElementById("thread"),m=document.querySelector(".watch-link a"),c=document.getElementById("comments-list"),y=document.getElementById("comments-sync"),b=document.querySelector(".detail-pc"),q=document.title,P="/nv-comment-viewer",A=location.pathname.replace(P,"").slice(1),k=`${location.origin}${P}/`,B=()=>window.innerWidth<1024;let u=null,v=null,T=!1,M=!1,x=[],S=!0,D=0;const H=()=>n.submitButton.disabled=!n.checkValidity();n.addEventListener("input",H);const F=e=>{const t={text:K(R(e.body)),nicoru:e.nicoruCount!==0?e.nicoruCount:"",time:(i=>i.getUTCDate()-1?(i.setUTCMonth(i.getUTCDate()-2),i.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):i.getUTCHours()?i.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2}):i.toLocaleString([],{timeZone:"UTC",minute:"numeric",second:"numeric",fractionalSecondDigits:2}))(new Date(Number(e.vposMs)))};return`<li data-id="${e.id}" data-user-id="${e.userId}" tabindex="0">
      <span class="text">${t.text}</span><span class="nicoru">${t.nicoru}</span><span class="time">${t.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(e)}<\/script>
    </li>
    `},N=e=>{let t="";x=[],e.forEach(o=>{t+=F(o),x.push(o.vposMs)}),c.insertAdjacentHTML("beforeend",t)};let U=null;if(n.addEventListener("submit",async e=>{e.preventDefault(),n.submitButton.disabled=!0,n.submitButton.textContent="読み込み中...",c.textContent="";let t=n.videoId.value;const o=t.lastIndexOf("/")+1,i=t.includes("?")?t.indexOf("?"):void 0,s=t.slice(o,i);if(n.videoId.value=s,m.href=`https://nico.ms/${s}`,(u==null?void 0:u.client.watchId)!==s){T&&e.isTrusted&&(T=!1,document.body.classList.remove("linked"));const w=new URL("watch_v3_guest",k),d=w.searchParams;d.append("id",s);const f=`${_.string(10)}_${Math.floor(Date.now()/1e3)}`;d.append("actionTrackId",f),await fetch(w,{method:"POST"}).then(async h=>{h.status!==200&&console.log("error or no content",h.status);const r=await h.json();r.meta.errorCode==="FORBIDDEN"?(console.error("Error:",r.meta.errorCode,r.data.reasonCode),alert(`エラー:${r.meta.errorCode}、理由:${r.data.reasonCode}`)):r.meta.errorCode?(console.error("Error:",r.meta.errorCode),alert("エラー:"+r.meta.errorCode)):(u=r.data,U=null)}).catch(h=>{console.error("Failed to load",h)})}if((u==null?void 0:u.client.watchId)===s){const w=u.comment.nvComment;await fetch(`${w.server}/v1/threads`,{method:"POST",headers:{"X-Client-Os-Type":"others","X-Frontend-Id":"6","X-Frontend-Version":"0"},body:JSON.stringify({params:w.params,threadKey:U||w.threadKey,additionals:{}})}).then(async d=>{if(d.status!==200&&console.log("error or no content",d.status),v=await d.json(),v.meta.errorCode==="EXPIRED_TOKEN"){const f=new URL("v1_comment_keys_thread",k);f.searchParams.append("videoId",s),await fetch(f,{}).then(async r=>(r.status!==200&&console.log("error or no content",r.status),r.json())).then(r=>{U=r.data.threadKey,n.requestSubmit()}).catch(r=>{console.error("Failed to load",r)})}else if(v.meta.errorCode)console.error("Error:",v.meta.errorCode),alert("エラー:"+v.meta.errorCode);else if(!v.data.globalComments[0].count)console.log("not comments found"),alert("コメントがありませんでした。");else{a.value="default",I.hidden=!1;const f=v.data.threads.find(h=>h.fork==="main");f.comments.sort((h,r)=>h.vposMs-r.vposMs),N(f.comments),document.title=`${u.video.title} - ${q}`,history.pushState(null,"",`${P}/${s}`)}}).catch(d=>{console.error("Failed to load",d)})}n.submitButton.disabled=!1,n.submitButton.textContent="取得"},{passive:!1}),a.addEventListener("change",()=>{c.textContent="";const e=v.data.threads.find(t=>{switch(a.value){case"default":return t.fork==="main";default:return t.fork===a.value}});e.comments.sort((t,o)=>t.vposMs-o.vposMs),N(e.comments)}),/(^sm|^nm|^so)[0-9]+/.test(A)){C.open=!1;const e=A;n.videoId.value=e,n.requestSubmit()}if(window.addEventListener("message",async e=>{if(e.origin==="https://www.nicovideo.jp")switch(e.data.eventName){case"sendData":case"sendVideoId":T=!0,document.body.classList.add("linked"),C.open=!1;let t="";e.data.eventName==="sendData"?(u=e.data.data,t=u.client.watchId):(u=null,t=e.data.data.videoId),M=await(async()=>{const o=new URL("pickup_supporters",k);return o.searchParams.append("id",t),fetch(o,{}).then(async s=>(s.status!==200&&console.log("error or no content",s.status),s.json())).then(s=>s.meta.status===200).catch(s=>{console.error("Failed to load",s)})})(),console.log("isIncludeNicoAd:",M),n.videoId.value=t,n.requestSubmit(),window.addEventListener("scroll",o=>{T?Math.abs(D-window.scrollY)>=3?(S=!1,y.hidden=!1):(S=!0,y.hidden=!0):y.hidden=!0});break;case"playerMetadataChange":if(S&&!n.submitButton.disabled){const o=u.video.duration,i=e.data.data.progressPercentage,s=Math.floor((o+(M?10:0))*1e3*i),w=x.findIndex(f=>f>s),d=c.children[w];D=d.offsetTop-window.innerHeight+d.offsetHeight+2,window.scrollTo({top:D,behavior:"instant"})}break;default:console.log(e.data);break}}),(O=window.opener)==null||O.postMessage({eventName:"ready"},"https://www.nicovideo.jp"),document.addEventListener("visibilitychange",()=>{var e,t;switch(document.visibilityState){case"hidden":(e=window.opener)==null||e.postMessage({eventName:"bye"},"https://www.nicovideo.jp");break;case"visible":(t=window.opener)==null||t.postMessage({eventName:"returned"},"https://www.nicovideo.jp");break}}),c.addEventListener("click",e=>{const t=e.target.closest("li"),o=document.querySelector(".detail-sp"),i=document.getElementsByClassName("same-user");if(!t||t.classList.contains("detail-sp"))return;if([...i].forEach(g=>g.classList.remove("same-user")),t.nextElementSibling&&t.nextElementSibling.classList.contains("detail-sp")){b.textContent="",o.remove();return}b.textContent!==""&&(b.textContent=""),o&&o.remove(),S=!1,y.hidden=!1;const s=B()?t.offsetTop-(l.offsetHeight+10+I.offsetHeight+2+10):t.offsetTop-(window.innerHeight-l.offsetHeight-t.offsetHeight)/2,w=e.isTrusted?"smooth":"instant";window.scrollTo({top:s,behavior:w});const d=JSON.parse(t.querySelector(".raw-data").textContent),f=document.createElement("dl"),h={id:"コメントID",no:"コメント番号",vposMs:"再生時間",body:"コメント",commands:"コマンド",userId:"ユーザーID",isPremium:"プレミアム会員",score:"NGスコア",postedAt:"日時",nicoruCount:"ニコられた数",source:"ソース",isMyPost:"自分の投稿"};let r="";Object.entries(d).forEach(([g,p])=>{switch(g){case"vposMs":const L=new Date(Number(p));L.getUTCDate()-1?(L.setUTCMonth(L.getUTCDate()-2),p=L.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):p=L.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"commands":p=p.join(" ");break;case"postedAt":p=new Date(p).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"userId":!d.commands.includes("184")&&(p=`<a href="https://nico.ms/user/${d.userId}" target="_blank">${p}</a>`);break;case"isPremium":case"isMyPost":p=p?"はい":"いいえ";break}r+=`<dt>${h[g]||g}</dt>
      <dd>${p}</dd>
      `}),f.innerHTML=r;const $=[...c.children].filter(g=>g.dataset.userId===d.userId),j=`<dl>
      <dt>コメント回数</dt>
      <dd>${$.findIndex(g=>g.dataset.id===d.id)+1}回目/全${$.length}回中</dd>
    </dl>
    `;b.appendChild(f.cloneNode(!0)),b.appendChild(document.createElement("hr")),b.insertAdjacentHTML("beforeend",j);const E=document.createElement("li");E.classList.add("detail-sp"),E.appendChild(f),E.appendChild(document.createElement("hr")),E.insertAdjacentHTML("beforeend",j),t.insertAdjacentElement("afterend",E),$.forEach(g=>g.classList.add("same-user"))}),y.addEventListener("click",()=>{var e;S=!0,y.hidden=!0,(e=document.querySelector(".detail-sp"))==null||e.previousElementSibling.click()}),window.opener)document.addEventListener("keydown",e=>{var i;["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"," "].some(s=>s===e.key)&&(e.preventDefault(),(i=window.opener)==null||i.postMessage({eventName:"keyDown",data:e.key},"https://www.nicovideo.jp"))});else{let e=null;c.addEventListener("focus",t=>{e=t.target},!0),c.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":t.preventDefault(),(()=>{const o=e?e.previousElementSibling??c.lastElementChild:c.firstElementChild;o.click(),o.focus()})();break;case"ArrowDown":t.preventDefault(),(()=>{var i,s;const o=((i=e==null?void 0:e.nextElementSibling)!=null&&i.classList.contains("detail-sp")?(s=e.nextElementSibling)==null?void 0:s.nextElementSibling:e==null?void 0:e.nextElementSibling)??c.firstElementChild;o.click(),o.focus()})();break;case" ":case"Enter":t.target===document.activeElement&&(t.preventDefault(),t.target.click(),t.target.focus());break}})}});
