(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))b(c);new MutationObserver(c=>{for(const r of c)if(r.type==="childList")for(const g of r.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&b(g)}).observe(document,{childList:!0,subtree:!0});function E(c){const r={};return c.integrity&&(r.integrity=c.integrity),c.referrerPolicy&&(r.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?r.credentials="include":c.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function b(c){if(c.ep)return;c.ep=!0;const r=E(c);fetch(c.href,r)}})();const R=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,l=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[l]),K=n=>n.replace(/\n/g,"<br>"),_={string(n){const l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array(n).fill(null).map(()=>l[Math.floor(Math.random()*l.length)]).join("")},number(n,l){return Math.floor(Math.random()*(l-n)+n)}};document.addEventListener("DOMContentLoaded",()=>{var A;document.querySelector("header");const n=document.forms["comments-load"];n.videoId=n.elements["video-id"],n.submitButton=n.elements["submit-button"];const l=document.querySelector("details"),E=document.querySelector(".config"),b=document.getElementById("thread"),c=document.querySelector(".watch-link a"),r=document.getElementById("comments-list"),g=document.getElementById("comments-sync"),y=document.querySelector(".detail-pc"),O=document.title,k="/nv-comment-viewer",U=location.pathname.replace(k,"").slice(1),P=`${location.origin}${k}/`,j=()=>window.innerWidth<1024;let m=null,v=null,L=!1,M=!1,x=[],C=!0,q=0;const B=()=>n.submitButton.disabled=!n.checkValidity();n.addEventListener("input",B);const F=e=>{const t={text:K(R(e.body)),nicoru:e.nicoruCount!==0?e.nicoruCount:"",time:(i=>i.getUTCDate()-1?(i.setUTCMonth(i.getUTCDate()-2),i.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):i.getUTCHours()?i.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2}):i.toLocaleString([],{timeZone:"UTC",minute:"numeric",second:"numeric",fractionalSecondDigits:2}))(new Date(Number(e.vposMs)))};return`<li data-id="${e.id}" data-user-id="${e.userId}" tabindex="0">
      <span class="text">${t.text}</span><span class="nicoru">${t.nicoru}</span><span class="time">${t.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(e)}<\/script>
    </li>
    `},$=e=>{let t="";x=[],e.forEach(o=>{t+=F(o),x.push(o.vposMs)}),r.insertAdjacentHTML("beforeend",t)};let T=null;if(n.addEventListener("submit",async e=>{e.preventDefault(),n.submitButton.disabled=!0,n.submitButton.textContent="読み込み中...",r.textContent="";let t=n.videoId.value;const o=t.lastIndexOf("/")+1,i=t.includes("?")?t.indexOf("?"):void 0,s=t.slice(o,i);if(n.videoId.value=s,c.href=`https://nico.ms/${s}`,(m==null?void 0:m.client.watchId)!==s){L&&e.isTrusted&&(L=!1,document.body.classList.remove("linked"));const w=new URL("watch_v3_guest",P),d=w.searchParams;d.append("id",s);const u=`${_.string(10)}_${Math.floor(Date.now()/1e3)}`;d.append("actionTrackId",u),await fetch(w,{method:"POST"}).then(async f=>{f.status!==200&&console.log("error or no content",f.status);const a=await f.json();a.meta.errorCode==="FORBIDDEN"?(console.error("Error:",a.meta.errorCode,a.data.reasonCode),alert(`エラー:${a.meta.errorCode}、理由:${a.data.reasonCode}`)):a.meta.errorCode?(console.error("Error:",a.meta.errorCode),alert("エラー:"+a.meta.errorCode)):(m=a.data,T=null)}).catch(f=>{console.error("Failed to load",f)})}if((m==null?void 0:m.client.watchId)===s){const w=m.comment.nvComment;await fetch(`${w.server}/v1/threads`,{method:"POST",headers:{"X-Client-Os-Type":"others","X-Frontend-Id":"6","X-Frontend-Version":"0"},body:JSON.stringify({params:w.params,threadKey:T||w.threadKey,additionals:{}})}).then(async d=>{if(d.status!==200&&console.log("error or no content",d.status),v=await d.json(),v.meta.errorCode==="EXPIRED_TOKEN"){const u=new URL("v1_comment_keys_thread",P);u.searchParams.append("videoId",s),await fetch(u,{}).then(async a=>(a.status!==200&&console.log("error or no content",a.status),a.json())).then(a=>{T=a.data.threadKey,n.requestSubmit()}).catch(a=>{console.error("Failed to load",a)})}else if(v.meta.errorCode)console.error("Error:",v.meta.errorCode),alert("エラー:"+v.meta.errorCode);else if(!v.data.globalComments[0].count)console.log("not comments found"),alert("コメントがありませんでした。");else{b.value="default",E.hidden=!1;const u=v.data.threads.find(f=>f.fork==="main");u.comments.sort((f,a)=>f.vposMs-a.vposMs),$(u.comments),document.title=`${m.video.title} - ${O}`,history.pushState(null,"",`${k}/${s}`)}}).catch(d=>{console.error("Failed to load",d)})}n.submitButton.disabled=!1,n.submitButton.textContent="取得"},{passive:!1}),b.addEventListener("change",()=>{r.textContent="";const e=v.data.threads.find(t=>{switch(b.value){case"default":return t.fork==="main";default:return t.fork===b.value}});e.comments.sort((t,o)=>t.vposMs-o.vposMs),$(e.comments)}),/(^sm|^nm|^so)[0-9]+/.test(U)){l.open=!1;const e=U;n.videoId.value=e,n.requestSubmit()}if(window.addEventListener("message",async e=>{if(e.origin==="https://www.nicovideo.jp")switch(e.data.eventName){case"sendData":case"sendVideoId":L=!0,document.body.classList.add("linked"),l.open=!1;let t="";e.data.eventName==="sendData"?(m=e.data.data,t=m.client.watchId):(m=null,t=e.data.data.videoId),M=await(async()=>{const o=new URL("pickup_supporters",P);return o.searchParams.append("id",t),fetch(o,{}).then(async s=>(s.status!==200&&console.log("error or no content",s.status),s.json())).then(s=>s.meta.status===200).catch(s=>{console.error("Failed to load",s)})})(),console.log("isIncludeNicoAd:",M),n.videoId.value=t,n.requestSubmit(),window.addEventListener("scroll",o=>{L?Math.abs(q-window.scrollY)>=3?(C=!1,g.hidden=!1):(C=!0,g.hidden=!0):g.hidden=!0});break;case"playerMetadataChange":if(C&&!n.submitButton.disabled){const o=m.video.duration,i=e.data.data.progressPercentage,s=Math.floor((o+(M?10:0))*1e3*i),w=x.findIndex(u=>u>s),d=r.children[w];d==null||d.scrollIntoView({block:"end",behavior:"instant"})}break;default:console.log(e.data);break}}),(A=window.opener)==null||A.postMessage({eventName:"ready"},"https://www.nicovideo.jp"),document.addEventListener("visibilitychange",()=>{var e,t;switch(document.visibilityState){case"hidden":(e=window.opener)==null||e.postMessage({eventName:"bye"},"https://www.nicovideo.jp");break;case"visible":(t=window.opener)==null||t.postMessage({eventName:"returned"},"https://www.nicovideo.jp");break}}),r.addEventListener("click",e=>{const t=e.target.closest("li"),o=document.querySelector(".detail-sp"),i=document.getElementsByClassName("same-user");if(!t||t.classList.contains("detail-sp"))return;if([...i].forEach(p=>p.classList.remove("same-user")),t.nextElementSibling&&t.nextElementSibling.classList.contains("detail-sp")){y.textContent="",o.remove();return}y.textContent!==""&&(y.textContent=""),o&&o.remove(),C=!1,g.hidden=!1;const s=j()?"start":"center",w=e.isTrusted?"smooth":"instant";t.scrollIntoView({block:s,behavior:w});const d=JSON.parse(t.querySelector(".raw-data").textContent),u=document.createElement("dl"),f={id:"コメントID",no:"コメント番号",vposMs:"再生時間",body:"コメント",commands:"コマンド",userId:"ユーザーID",isPremium:"プレミアム会員",score:"NGスコア",postedAt:"日時",nicoruCount:"ニコられた数",source:"ソース",isMyPost:"自分の投稿"};let a="";Object.entries(d).forEach(([p,h])=>{switch(p){case"vposMs":const S=new Date(Number(h));S.getUTCDate()-1?(S.setUTCMonth(S.getUTCDate()-2),h=S.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):h=S.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"commands":h=h.join(" ");break;case"postedAt":h=new Date(h).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"userId":!d.commands.includes("184")&&(h=`<a href="https://nico.ms/user/${d.userId}" target="_blank">${h}</a>`);break;case"isPremium":case"isMyPost":h=h?"はい":"いいえ";break}a+=`<dt>${f[p]||p}</dt>
      <dd>${h}</dd>
      `}),u.innerHTML=a;const D=[...r.children].filter(p=>p.dataset.userId===d.userId),N=`<dl>
      <dt>コメント回数</dt>
      <dd>${D.findIndex(p=>p.dataset.id===d.id)+1}回目/全${D.length}回中</dd>
    </dl>
    `;y.appendChild(u.cloneNode(!0)),y.appendChild(document.createElement("hr")),y.insertAdjacentHTML("beforeend",N);const I=document.createElement("li");I.classList.add("detail-sp"),I.appendChild(u),I.appendChild(document.createElement("hr")),I.insertAdjacentHTML("beforeend",N),t.insertAdjacentElement("afterend",I),D.forEach(p=>p.classList.add("same-user"))}),g.addEventListener("click",()=>{var e;C=!0,g.hidden=!0,(e=document.querySelector(".detail-sp"))==null||e.previousElementSibling.click()}),window.opener)document.addEventListener("keydown",e=>{var i;["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"," "].some(s=>s===e.key)&&(e.preventDefault(),(i=window.opener)==null||i.postMessage({eventName:"keyDown",data:e.key},"https://www.nicovideo.jp"))});else{let e=null;r.addEventListener("focus",t=>{e=t.target},!0),r.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":t.preventDefault(),(()=>{const o=e?e.previousElementSibling??r.lastElementChild:r.firstElementChild;o.click(),o.focus()})();break;case"ArrowDown":t.preventDefault(),(()=>{var i,s;const o=((i=e==null?void 0:e.nextElementSibling)!=null&&i.classList.contains("detail-sp")?(s=e.nextElementSibling)==null?void 0:s.nextElementSibling:e==null?void 0:e.nextElementSibling)??r.firstElementChild;o.click(),o.focus()})();break;case" ":case"Enter":t.target===document.activeElement&&(t.preventDefault(),t.target.click(),t.target.focus());break}})}});
