(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))I(o);new MutationObserver(o=>{for(const u of o)if(u.type==="childList")for(const y of u.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&I(y)}).observe(document,{childList:!0,subtree:!0});function b(o){const u={};return o.integrity&&(u.integrity=o.integrity),o.referrerPolicy&&(u.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?u.credentials="include":o.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function I(o){if(o.ep)return;o.ep=!0;const u=b(o);fetch(o.href,u)}})();const R=s=>typeof s!="string"?s:s.replace(/[&'`"<>]/g,n=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[n]),_={string(s){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array(s).fill(null).map(()=>n[Math.floor(Math.random()*n.length)]).join("")},number(s,n){return Math.floor(Math.random()*(n-s)+s)}};document.addEventListener("DOMContentLoaded",()=>{var O;const s=document.querySelector(".list-area"),n=document.forms["comments-load"];n.videoId=n.elements["video-id"],n.submitButton=n.elements["submit-button"];const b=document.querySelector("details"),I=document.querySelector(".config"),o=document.getElementById("thread"),u=document.querySelector(".watch-link a"),y=document.querySelector(".nico-ad"),q=document.getElementById("nico-ad"),v=document.getElementById("comments-list"),S=document.getElementById("comments-sync"),C=document.querySelector(".detail-pc"),B=document.title,P="/nv-comment-viewer",x=location.pathname.replace(P,"").slice(1),A=`${location.origin}${P}/`,F=()=>window.innerWidth<1024;let f=null,w=null,T=!1,$=[],M=!0,k=0;const H=()=>n.submitButton.disabled=!n.checkValidity();n.addEventListener("input",H);const K=e=>{const t={text:R(e.body).replace(/\n/g,"<br>"),nicoru:e.nicoruCount!==0?e.nicoruCount:"",time:(a=>a.getUTCDate()-1?(a.setUTCMonth(a.getUTCDate()-2),a.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):a.getUTCHours()?a.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2}):a.toLocaleString([],{timeZone:"UTC",minute:"numeric",second:"numeric",fractionalSecondDigits:2}))(new Date(Number(e.vposMs)))};return`<li data-id="${e.id}" data-user-id="${e.userId}">
      <span class="text">${t.text}</span><span class="nicoru">${t.nicoru}</span><span class="time">${t.time}</span>
      <script type="application/json" class="raw-data">${JSON.stringify(e)}<\/script>
    </li>
    `},N=e=>{let t="";$=[],e.forEach(i=>{t+=K(i),$.push(i.vposMs)}),v.insertAdjacentHTML("beforeend",t)};let D=null;if(n.addEventListener("submit",async e=>{e.preventDefault(),n.submitButton.disabled=!0,n.submitButton.textContent="読み込み中...",v.textContent="";let t=n.videoId.value;const i=t.lastIndexOf("/")+1,a=t.includes("?")?t.indexOf("?"):void 0,c=t.slice(i,a);if(n.videoId.value=c,u.href=`https://nico.ms/${c}`,!f||f.client.watchId!==c){T&&f.client.watchId!==c&&(T=!1,y.hidden=!0);const l=new URL("watch_v3_guest",A),m=l.searchParams;m.append("id",c);const h=`${_.string(10)}_${Math.floor(Date.now()/1e3)}`;m.append("actionTrackId",h),await fetch(l,{method:"POST"}).then(async d=>{d.status!==200&&console.log("error or no content",d.status);const r=await d.json();r.meta.errorCode==="FORBIDDEN"?(console.error("Error:",r.meta.errorCode,r.data.reasonCode),alert(`エラー:${r.meta.errorCode}、理由:${r.data.reasonCode}`)):r.meta.errorCode?(console.error("Error:",r.meta.errorCode),alert("エラー:"+r.meta.errorCode)):(f=r.data,D=null)}).catch(d=>{console.error("Failed to load",d)})}if((f==null?void 0:f.client.watchId)===c){const l=f.comment.nvComment;await fetch(`${l.server}/v1/threads`,{method:"POST",headers:{"Content-Type":"application/json","X-Frontend-Id":"1","X-Frontend-Version":"0"},body:JSON.stringify({params:l.params,threadKey:D||l.threadKey,additionals:{}})}).then(async m=>{if(m.status!==200&&console.log("error or no content",m.status),w=await m.json(),w.meta.errorCode==="EXPIRED_TOKEN"){const h=new URL("v1_comment_keys_thread",A);h.searchParams.append("videoId",c),await fetch(h,{}).then(async r=>(r.status!==200&&console.log("error or no content",r.status),r.json())).then(r=>{D=r.data.threadKey,n.requestSubmit()}).catch(r=>{console.error("Failed to load",r)})}else if(w.meta.errorCode)console.error("Error:",w.meta.errorCode),alert("エラー:"+w.meta.errorCode);else if(!w.data.globalComments[0].count)console.log("not comments found"),alert("コメントがありませんでした。");else{o.value="default",I.hidden=!1;const h=w.data.threads.find(d=>d.fork==="main");h.comments.sort((d,r)=>d.vposMs-r.vposMs),N(h.comments),document.title=`${f.video.title} - ${B}`,history.pushState(null,"",`${P}/${c}`)}}).catch(m=>{console.error("Failed to load",m)})}n.submitButton.disabled=!1,n.submitButton.textContent="取得"},{passive:!1}),o.addEventListener("change",()=>{v.textContent="";const e=w.data.threads.find(t=>{switch(o.value){case"default":return t.fork==="main";default:return t.fork===o.value}});e.comments.sort((t,i)=>t.vposMs-i.vposMs),N(e.comments)}),/(^sm|^nm|^so)[0-9]+/.test(x)){b.open=!1;const e=x;n.videoId.value=e,n.requestSubmit()}window.addEventListener("message",e=>{if(e.origin==="https://www.nicovideo.jp")switch(e.data.eventName){case"sendData":T=!0,b.open=!1,y.hidden=!1,f=e.data.data;const t=f.client.watchId;n.videoId.value=t,n.requestSubmit(),s.addEventListener("scroll",i=>{T?Math.abs(k-s.scrollTop)>=3?(M=!1,S.hidden=!1):(M=!0,S.hidden=!0):S.hidden=!0});break;case"playerMetadataChange":if(M){const i=f.video.duration,a=e.data.data.progressPercentage,c=q.checked,l=Math.floor((i+(c?10:0))*1e3*a),m=$.findIndex(d=>d>l),h=v.children[m];k=h.offsetTop-s.clientHeight+h.offsetHeight+2,s.scrollTo({top:k,behavior:"instant"})}break;default:console.log(e.data);break}}),(O=window.opener)==null||O.postMessage({eventName:"ready"},"https://www.nicovideo.jp"),document.addEventListener("visibilitychange",()=>{var e,t;switch(document.visibilityState){case"hidden":(e=window.opener)==null||e.postMessage({eventName:"bye"},"https://www.nicovideo.jp");break;case"visible":(t=window.opener)==null||t.postMessage({eventName:"returned"},"https://www.nicovideo.jp");break}}),v.addEventListener("click",e=>{const t=e.target.closest("li"),i=document.querySelector(".detail-sp"),a=document.getElementsByClassName("same-user");if(!t||t.classList.contains("detail-sp"))return;if([...a].forEach(g=>g.classList.remove("same-user")),t.nextElementSibling&&t.nextElementSibling.classList.contains("detail-sp")){C.textContent="",i.remove();return}C.textContent!==""&&(C.textContent=""),i&&i.remove();const c=F()?t.offsetTop-2-I.offsetHeight-10:t.offsetTop-(s.clientHeight-t.offsetHeight)/2;s.scrollTo({top:c});const l=JSON.parse(t.querySelector(".raw-data").textContent),m=document.createElement("dl"),h={id:"コメントID",no:"コメント番号",vposMs:"再生時間",body:"コメント",commands:"コマンド",userId:"ユーザーID",isPremium:"プレミアム会員",score:"NGスコア",postedAt:"日時",nicoruCount:"ニコられた数",source:"ソース",isMyPost:"自分の投稿"};let d="";Object.entries(l).forEach(([g,p])=>{switch(g){case"vposMs":const E=new Date(Number(p));E.getUTCDate()-1?(E.setUTCMonth(E.getUTCDate()-2),p=E.toLocaleString([],{timeZone:"UTC",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2})):p=E.toLocaleString([],{timeZone:"UTC",hour:"numeric",minute:"numeric",second:"numeric",fractionalSecondDigits:2});break;case"commands":p=p.join(" ");break;case"postedAt":p=new Date(p).toLocaleString([],{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});break;case"userId":!l.commands.includes("184")&&(p=`<a href="https://nico.ms/user/${l.userId}" target="_blank">${p}</a>`);break;case"isPremium":case"isMyPost":p=p?"はい":"いいえ";break}d+=`<dt>${h[g]||g}</dt>
      <dd>${p}</dd>
      `}),m.innerHTML=d;const U=[...v.children].filter(g=>g.dataset.userId===l.userId),j=`<dl>
      <dt>コメント回数</dt>
      <dd>${U.findIndex(g=>g.dataset.id===l.id)+1}回目/全${U.length}回中</dd>
    </dl>
    `;C.appendChild(m.cloneNode(!0)),C.appendChild(document.createElement("hr")),C.insertAdjacentHTML("beforeend",j);const L=document.createElement("li");L.classList.add("detail-sp"),L.appendChild(m),L.appendChild(document.createElement("hr")),L.insertAdjacentHTML("beforeend",j),t.insertAdjacentElement("afterend",L),U.forEach(g=>g.classList.add("same-user"))}),S.addEventListener("click",()=>{var e;M=!0,S.hidden=!0,(e=document.querySelector(".detail-sp"))==null||e.previousElementSibling.click()}),window.opener&&document.addEventListener("keydown",e=>{var a;["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"," "].some(c=>c===e.key)&&(e.preventDefault(),(a=window.opener)==null||a.postMessage({eventName:"keyDown",data:e.key},"https://www.nicovideo.jp"))})});
